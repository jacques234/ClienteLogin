<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inicio</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
</head>

<body>
    <h1>Home!!</h1>

    <button id="btnRefresh"> refrescar token</button>
</body>

</html>
<script>
    const key = "2BE1moQ*4{w(uh?W?]SlB9W1Hsl`|<8j";
    async function getDeviceId(params) {
        const { default: FingerprintJS } = await import('./fingerprint.js');

        const fp = await FingerprintJS.load();
        const result = await fp.get();

        return result.visitorId;
    }

    const decrypt = (encrypted) => {
        const decrypted = CryptoJS.AES.decrypt(encrypted, key).toString(CryptoJS.enc.Utf8);
        return decrypted;
    }

    let btnRefresh = document.getElementById('btnRefresh')
    btnRefresh.addEventListener('click', async function () {
        let deviceId = localStorage.getItem("deviceId");
        let ipDevice = "Desconocida";
        if (!deviceId) {
            deviceId = await getDeviceId();
            localStorage.setItem("deviceId", deviceId);
        }
        const request = indexedDB.open("Prueba", 1);

        request.onsuccess = async (event) => {
            const db = event.target.result;
            const transaction = db.transaction("tokens", "readonly");
            const store = transaction.objectStore("tokens");

            const getRequest = store.get(deviceId);

            getRequest.onsuccess = async (event) => {
                const result = event.target.result;
                if (result) {
                    console.log("Token encontrado:", result);
                    let refreshToken = decrypt(result.value)
                    console.log(refreshToken, result.refreshTokenId)
                    // Aqu√≠ podr√≠as llamar a renovarAccessToken(result.value) si quieres
                    await renovarAccessToken(result.refreshTokenId, refreshToken);
                } else {
                    console.log("No se encontr√≥ ning√∫n token con ese ID.");
                }
            };

            getRequest.onerror = () => {
                console.error("Error al obtener token de IndexedDB");
            };
        };

        request.onerror = () => {
            console.error("Error al abrir IndexedDB");
        };

    })
    const encrypt = (refreshToken, refreshTokenId, deviceId) => {
        const data = refreshToken;
        const encrypted = CryptoJS.AES.encrypt(refreshToken, key).toString();
        // console.log("Encrypted:", encrypted);
        const request = indexedDB.open("Prueba", 1)
        request.onsuccess = (event) => {
            const db = event.target.result;
            const transaction = db.transaction("tokens", "readwrite")
            const store = transaction.objectStore("tokens");
            store.put({ id: deviceId, value: encrypted, refreshTokenId: refreshTokenId })
        };

    }
    async function renovarAccessToken(refreshTokenId, refreshToken) {
        try {
            const deviceId = localStorage.getItem("deviceId") || "unknown";
            const response = await fetch("http://localhost:5158/api/Login/refresh-token", {
                method: "POST",
                credentials: "include", // üî• Enviar la cookie HttpOnly autom√°ticamente
                headers: {
                    "Device-Id": deviceId,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(
                    {
                        refreshToken: refreshToken,
                        refreshTokenId: refreshTokenId,
                        ip: "Desconocido"
                    }
                )
            });

            if (!response.ok) {
                throw new Error("Sesi√≥n expirada, por favor inicia sesi√≥n nuevamente.");
            }

            const data = await response.json();
            sessionStorage.setItem("accessToken", data.usuarioInfo); // ‚úÖ Guardar solo el accessToken
            encrypt(data.refreshToken, data.refreshTokenId, deviceId)
        } catch (error) {
            console.error(error.message);
            // window.location.href = "/login"; // Redirigir si la sesi√≥n expir√≥
        }
    }
</script>